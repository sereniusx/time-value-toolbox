<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>时间价值工具箱</title>

    <style>
        :root{
            /* 极简白底 */
            --bg1:#ffffff;
            --bg2:#f6f7f9;

            /* 卡片与描边（黑白系） */
            --card: rgba(255,255,255,.92);
            --card2: rgba(255,255,255,.84);
            --stroke: rgba(17,24,39,.10);

            /* 文字（深灰） */
            --text: rgba(17,24,39,.92);
            --muted: rgba(17,24,39,.62);
            --muted2: rgba(17,24,39,.48);

            /* 状态色（克制） */
            --good: rgba(16,185,129,.85);
            --warn: rgba(245,158,11,.85);
            --bad:  rgba(239,68,68,.85);

            --shadow: 0 10px 28px rgba(0,0,0,.08);
            --radius: 18px;
        }

        *{ box-sizing: border-box; }
        html,body{ height:100%; }
        body{
            margin:0;
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
            color: var(--text);
            background: var(--bg1);
            overflow-x: hidden;
        }

        /* ✅ 固定背景层：不随滚动（极简） */
        .bg{
            position: fixed;
            inset: 0;
            z-index: -1;
            background: linear-gradient(180deg, var(--bg1), var(--bg2));
            transform: translateZ(0);
            will-change: transform;
        }

        .wrap{
            max-width: 1120px;
            margin: 0 auto;
            padding: 20px 16px 64px;
        }

        /* Top bar（白底半透明） */
        .topbar{
            position: sticky;
            top: 0;
            z-index: 50;
            padding: 12px 0;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.62));
            border-bottom: 1px solid rgba(17,24,39,.08);
        }

        header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 14px;
            padding: 6px 0 10px;
        }
        .title{
            display:flex;
            flex-direction:column;
            gap:6px;
        }
        h1{
            margin:0;
            font-size: 20px;
            letter-spacing:.4px;
            line-height:1.2;
        }
        .subtitle{
            color: var(--muted);
            font-size: 12px;
            line-height: 1.45;
            max-width: 760px;
        }
        .pill{
            display:inline-flex;
            align-items:center;
            gap:8px;
            padding:8px 12px;
            border-radius: 999px;
            background: rgba(255,255,255,.72);
            border: 1px solid rgba(17,24,39,.10);
            color: var(--muted);
            font-size: 12px;
            white-space: nowrap;
        }

        /* Nav（黑白系） */
        .nav{
            display:flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items:center;
            padding-bottom: 6px;
        }
        .navbtn{
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid rgba(17,24,39,.12);
            background: rgba(255,255,255,.72);
            color: rgba(17,24,39,.78);
            font-size: 12px;
            cursor: pointer;
            user-select:none;
            transition: transform .05s ease, background .15s ease, border-color .15s ease;
        }
        .navbtn:hover{ background: rgba(255,255,255,.92); }
        .navbtn:active{ transform: translateY(1px); }
        .navbtn.active{
            background: rgba(17,24,39,.92);
            border-color: rgba(17,24,39,.92);
            color: rgba(255,255,255,.96);
        }

        /* Layout */
        .grid{
            display:grid;
            grid-template-columns: 1.2fr .8fr;
            gap: 16px;
            margin-top: 16px;
        }
        @media (max-width: 960px){
            .grid{ grid-template-columns: 1fr; }
            header{ flex-direction: column; align-items:flex-start; }
            .pill{ align-self: flex-start; }
        }

        .card{
            background: linear-gradient(180deg, var(--card), var(--card2));
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 16px;
        }

        .card h2{
            margin:0;
            font-size: 16px;
            letter-spacing: .2px;
        }
        .desc{
            margin-top: 6px;
            color: var(--muted);
            font-size: 13px;
            line-height: 1.5;
        }

        .row{
            display:flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        label{
            color: var(--muted);
            font-size: 12px;
            display:block;
            margin: 10px 0 6px;
        }

        input, select, textarea{
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(17,24,39,.14);
            background: rgba(255,255,255,.88);
            color: var(--text);
            outline: none;
            transition: border .15s ease;
        }
        input:focus, select:focus, textarea:focus{
            border-color: rgba(17,24,39,.40);
        }
        input::placeholder, textarea::placeholder{
            color: rgba(17,24,39,.35);
        }

        .btns{
            display:flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }

        button{
            border: 0;
            border-radius: 14px;
            padding: 10px 12px;
            cursor: pointer;
            color: rgba(17,24,39,.92);
            background: rgba(255,255,255,.92);
            border: 1px solid rgba(17,24,39,.14);
            transition: transform .05s ease, opacity .15s ease, background .15s ease;
            font-size: 13px;
        }
        button:hover{ background: rgba(255,255,255,1); }
        button:active{ transform: translateY(1px); }

        .primary{
            background: rgba(17,24,39,.92);
            border: 1px solid rgba(17,24,39,.92);
            color: rgba(255,255,255,.96);
        }
        .primary:hover{ background: rgba(17,24,39,1); }

        .danger{
            background: rgba(239,68,68,.10);
            border: 1px solid rgba(239,68,68,.22);
            color: rgba(17,24,39,.92);
        }

        .chip{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(17,24,39,.12);
            background: rgba(255,255,255,.86);
            color: var(--muted);
            font-size: 12px;
            user-select: none;
        }

        .big-balance{
            display:flex;
            align-items:flex-end;
            justify-content:space-between;
            gap: 12px;
            padding: 14px;
            border-radius: 18px;
            border: 1px solid rgba(17,24,39,.10);
            background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
            margin-top: 12px;
        }
        .big-balance .num{
            font-size: 30px;
            font-weight: 800;
            letter-spacing: .5px;
            line-height: 1;
        }
        .big-balance .unit{
            color: var(--muted);
            font-size: 12px;
            margin-top: 6px;
        }

        .kpi{
            display:grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 12px;
        }
        .kpi .box{
            border-radius: 16px;
            border: 1px solid rgba(17,24,39,.10);
            background: rgba(255,255,255,.88);
            padding: 12px;
        }
        .kpi .name{ color: var(--muted); font-size: 12px; margin-bottom: 6px; }
        .kpi .val{ font-size: 18px; font-weight: 700; }
        .kpi .hint{ margin-top: 6px; font-size: 12px; color: var(--muted2); line-height: 1.4; }

        .list{
            margin-top: 12px;
            border-radius: 16px;
            border: 1px solid rgba(17,24,39,.10);
            overflow:hidden;
        }
        .item{
            padding: 12px 12px;
            background: rgba(255,255,255,.88);
            border-bottom: 1px solid rgba(17,24,39,.08);
            display:flex;
            align-items:flex-start;
            justify-content:space-between;
            gap: 12px;
        }
        .item:last-child{ border-bottom:0; }
        .left{ display:flex; flex-direction:column; gap: 6px; min-width:0; }
        .topline{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
        .tag{
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid rgba(17,24,39,.12);
            background: rgba(255,255,255,.92);
            color: rgba(17,24,39,.82);
        }
        .tag.learn,.tag.work,.tag.rest,.tag.cost{ border-color: rgba(17,24,39,.14); background: rgba(255,255,255,.92); }

        .meta{ color: var(--muted); font-size: 12px; }
        .note{
            color: rgba(17,24,39,.86);
            font-size: 13px;
            line-height: 1.45;
            word-break: break-word;
            opacity: .95;
        }
        .right{ text-align:right; flex-shrink:0; min-width: 160px; }
        .money{ font-weight: 800; font-size: 14px; }
        .submoney{ margin-top: 6px; color: var(--muted2); font-size: 12px; line-height: 1.35; }

        .hintline{ margin-top: 10px; color: var(--muted2); font-size: 12px; line-height: 1.45; }

        .divider{
            height:1px;
            background: rgba(17,24,39,.08);
            margin: 14px 0;
        }

        .toast{
            position: fixed;
            left: 50%;
            bottom: 18px;
            transform: translateX(-50%);
            background: rgba(17,24,39,.92);
            border: 1px solid rgba(17,24,39,.92);
            color: rgba(255,255,255,.96);
            padding: 10px 12px;
            border-radius: 999px;
            box-shadow: 0 10px 30px rgba(0,0,0,.18);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            font-size: 13px;
            display:none;
            max-width: 90vw;
            white-space: nowrap;
            overflow:hidden;
            text-overflow: ellipsis;
            z-index: 999;
        }

        .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .footer{
            margin-top: 18px;
            color: var(--muted2);
            font-size: 12px;
            text-align: center;
            padding-bottom: 10px;
        }

        .smallbtn{
            padding: 8px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        /* Sections */
        .section{ display:none; }
        .section.active{ display:block; }

        /* AI box */
        .aiBox{
            margin-top: 12px;
            border: 1px dashed rgba(17,24,39,.18);
            border-radius: 16px;
            padding: 12px;
            background: rgba(255,255,255,.88);
        }
        .aiOut{
            margin-top: 10px;
            padding: 10px;
            border-radius: 14px;
            border: 1px solid rgba(17,24,39,.10);
            background: rgba(255,255,255,.92);
            color: rgba(17,24,39,.86);
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>

<body>
<div class="bg" aria-hidden="true"></div>

<div class="topbar">
    <div class="wrap">
        <header>
            <div class="title">
                <h1>时间价值工具箱</h1>
                <div class="subtitle">
                    把“时间”当成一种资产来管理：用时薪折算价值、记录行为并累积“时间价值余额”（等价价值，不是现金）。
                </div>
            </div>
            <div class="pill">Cloudflare Pages · localStorage 本地数据</div>
        </header>

        <div class="nav" id="nav">
            <div class="navbtn active" data-target="sec-dashboard">仪表盘</div>
            <div class="navbtn" data-target="sec-calc">计算器</div>
            <div class="navbtn" data-target="sec-log">新增记录</div>
            <div class="navbtn" data-target="sec-ledger">账本</div>
            <div class="navbtn" data-target="sec-settings">设置</div>
            <div class="navbtn" data-target="sec-data">数据</div>
            <div class="navbtn" data-target="sec-about">说明</div>
        </div>
    </div>
</div>

<div class="wrap">

    <!-- 仪表盘 -->
    <section class="section active" id="sec-dashboard">
        <div class="grid">
            <div class="card">
                <h2>仪表盘</h2>
                <div class="desc">你的时间价值余额与近 14 天基础统计。</div>

                <div class="big-balance">
                    <div>
                        <div class="num" id="balance">0.00</div>
                        <div class="unit">时间价值余额（元等价）</div>
                    </div>
                    <div style="text-align:right;">
                        <div class="chip">keys：tv.settings.v1 / tv.logs.v1 / tv.balance.v1</div>
                    </div>
                </div>

                <div class="kpi">
                    <div class="box">
                        <div class="name">近 14 天记录数</div>
                        <div class="val" id="kpiCount">0</div>
                        <div class="hint">是否在持续记录。</div>
                    </div>
                    <div class="box">
                        <div class="name">近 14 天总时长</div>
                        <div class="val" id="kpiMins">0 分钟</div>
                        <div class="hint">仅统计有时长的记录（消费不计时长）。</div>
                    </div>
                    <div class="box">
                        <div class="name">近 14 天“学习+工作”占比</div>
                        <div class="val" id="kpiFocus">0%</div>
                        <div class="hint">建设性时间比例。</div>
                    </div>
                    <div class="box">
                        <div class="name">近 14 天时间价值（按默认时薪）</div>
                        <div class="val" id="kpiValue">0.00</div>
                        <div class="hint">等价价值，不是收入。</div>
                    </div>
                </div>

                <div class="hintline">
                    使用建议：先在【设置】里确定 A/B/C → 再在【新增记录】持续记录 → 用仪表盘看趋势 → 再逐步引入 AI 复盘。
                </div>
            </div>

            <div class="card">
                <h2>最近记录</h2>
                <div class="desc">展示最近 8 条（方便快速回看）。</div>
                <div class="list" id="recentList"></div>
            </div>
        </div>
    </section>

    <!-- 计算器 -->
    <section class="section" id="sec-calc">
        <div class="grid">
            <div class="card">
                <h2>时间 ⇄ 金钱换算</h2>
                <div class="desc">把某段时间换算成等价价值（选择 A/B/C 时薪）。</div>

                <div class="row" style="margin-top:10px;">
                    <div style="flex:1; min-width: 220px;">
                        <label>分钟</label>
                        <input type="number" id="minutes" placeholder="例如 45" />
                    </div>
                    <div style="width: 220px; flex:0 0 220px;">
                        <label>使用时薪</label>
                        <select id="convertRate">
                            <option value="B">B 有效时薪</option>
                            <option value="A">A 标准时薪</option>
                            <option value="C">C 私人时间</option>
                        </select>
                    </div>
                </div>

                <div class="btns">
                    <button class="primary" id="btnConvert">换算</button>
                    <button id="btnConvertClear">清空</button>
                </div>

                <div class="hintline" id="convertResult"></div>
            </div>

            <div class="card">
                <h2>回本计算</h2>
                <div class="desc">成本 ÷（每月节省时间 × 时薪）= 回本月数。</div>

                <div class="row" style="margin-top:10px;">
                    <div style="flex:1; min-width: 220px;">
                        <label>成本（元）</label>
                        <input type="number" id="cost" placeholder="例如 399" />
                    </div>
                    <div style="flex:1; min-width: 220px;">
                        <label>每月节省时间（分钟）</label>
                        <input type="number" id="saveTime" placeholder="例如 120" />
                    </div>
                    <div style="width: 220px; flex:0 0 220px;">
                        <label>使用时薪</label>
                        <select id="breakevenRate">
                            <option value="B">B 有效时薪</option>
                            <option value="A">A 标准时薪</option>
                            <option value="C">C 私人时间</option>
                        </select>
                    </div>
                </div>

                <div class="btns">
                    <button class="primary" id="btnBreakeven">计算回本</button>
                    <button id="btnBreakevenClear">清空</button>
                </div>

                <div class="hintline" id="breakevenResult"></div>

                <div class="divider"></div>

                <h2 style="font-size:14px;">消费回本（快速）</h2>
                <div class="desc">把一次消费换算成“需要工作/学习多久才能赚回来”。</div>

                <div class="row" style="margin-top:10px;">
                    <div style="flex:1; min-width: 220px;">
                        <label>消费金额（元）</label>
                        <input type="number" id="spendCostQuick" placeholder="例如 199" />
                    </div>
                    <div style="width: 220px; flex:0 0 220px;">
                        <label>按哪个时薪回本</label>
                        <select id="spendRateQuick">
                            <option value="B">B 有效时薪</option>
                            <option value="A">A 标准时薪</option>
                            <option value="C">C 私人时间</option>
                        </select>
                    </div>
                </div>

                <div class="btns">
                    <button class="primary" id="btnSpendQuick">换算回本时间</button>
                    <button id="btnSpendQuickClear">清空</button>
                </div>
                <div class="hintline" id="spendQuickResult"></div>
            </div>
        </div>
    </section>

    <!-- 新增记录 -->
    <section class="section" id="sec-log">
        <div class="card">
            <h2>新增行为记录</h2>
            <div class="desc">
                学习/恢复/工作按“时长”记录；消费按“金额”记录并可换算回本时间（不要求填写时长）。
            </div>

            <div class="row" style="margin-top:10px;">
                <div style="flex:1; min-width: 220px;">
                    <label>类型</label>
                    <select id="type">
                        <option value="学习">学习 / 读书（延迟收益）</option>
                        <option value="恢复">恢复 / 休闲（恢复精力）</option>
                        <option value="工作">工作 / 产出（直接收益）</option>
                        <option value="消费">消费（金额换算回本时间）</option>
                    </select>
                </div>

                <div style="width: 220px; flex:0 0 220px;" id="durationWrap">
                    <label>时长（分钟）</label>
                    <input type="number" id="duration" placeholder="例如 30" />
                </div>

                <div style="width: 220px; flex:0 0 220px; display:none;" id="costWrap">
                    <label>消费金额（元）</label>
                    <input type="number" id="spendCost" placeholder="例如 199" />
                </div>

                <div style="flex:1; min-width: 260px;">
                    <label>备注</label>
                    <input type="text" id="note" placeholder="例如：读《原则》/ 写方案 / 餐饮/会员" />
                </div>
            </div>

            <div class="row" style="margin-top:6px;">
                <div style="width: 220px; flex:0 0 220px;">
                    <label>恢复分（0-5，可选）</label>
                    <input type="number" id="recoverScore" placeholder="例如 3" min="0" max="5" />
                </div>
                <div style="width: 220px; flex:0 0 220px;">
                    <label>资产分（0-5，可选）</label>
                    <input type="number" id="assetScore" placeholder="例如 4" min="0" max="5" />
                </div>
                <div style="flex:1; min-width: 260px;">
                    <label>是否有输出（可选）</label>
                    <select id="hasOutput">
                        <option value="unknown">未标记</option>
                        <option value="yes">有（写了/产出了/推进了）</option>
                        <option value="no">无（纯吸收/纯休息/无产出）</option>
                    </select>
                </div>
            </div>

            <div class="row" style="margin-top:6px;">
                <div style="width: 240px; flex:0 0 240px;">
                    <label>价值/回本按哪个时薪算</label>
                    <select id="logRate">
                        <option value="B">B 有效时薪</option>
                        <option value="A">A 标准时薪</option>
                        <option value="C">C 私人时间</option>
                    </select>
                </div>

                <div style="flex:1; min-width: 280px;">
                    <label>预览</label>
                    <div class="hintline" id="logPreviewLine"></div>
                    <div class="hintline" id="logValueRuleHint"></div>
                </div>
            </div>

            <div class="btns">
                <button class="primary" id="btnAddLog">保存记录</button>
                <button id="btnQuickAdd10">+10 分钟</button>
                <button id="btnQuickAdd30">+30 分钟</button>
                <button id="btnQuickAdd60">+60 分钟</button>
            </div>

            <div class="hintline">
                说明：消费记录不必填时长，只记录金额，并展示“需要工作/学习多久回本”。后续再考虑是否要把消费影响纳入余额（比如扣减）。
            </div>
        </div>
    </section>

    <!-- 账本 -->
    <section class="section" id="sec-ledger">
        <div class="card">
            <h2>行为账本</h2>
            <div class="desc">筛选、搜索、查看最近记录。默认显示最近 100 条。</div>

            <div class="row" style="margin-top:10px;">
                <div style="flex:1; min-width: 220px;">
                    <label>筛选类型</label>
                    <select id="filterType">
                        <option value="all">全部</option>
                        <option value="学习">学习</option>
                        <option value="恢复">恢复</option>
                        <option value="工作">工作</option>
                        <option value="消费">消费</option>
                    </select>
                </div>
                <div style="flex:1; min-width: 260px;">
                    <label>搜索备注关键词</label>
                    <input type="text" id="searchText" placeholder="例如：读书 / 方案 / 会员" />
                </div>
                <div style="width: 220px; flex:0 0 220px;">
                    <label>显示数量</label>
                    <select id="limit">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                    </select>
                </div>
            </div>

            <div class="btns">
                <button id="btnRefresh">刷新列表</button>
                <button class="danger" id="btnClearLogs">清空账本</button>
            </div>

            <div class="list" id="logs"></div>
        </div>
    </section>

    <!-- 设置 -->
    <section class="section" id="sec-settings">
        <div class="grid">
            <div class="card">
                <h2>时薪与规则设置</h2>
                <div class="desc">
                    A/B/C 是你的“时间定价标尺”。建议先在这里定好，再开始记录。
                </div>

                <div class="row" style="margin-top:12px;">
                    <div style="flex:1; min-width: 220px;">
                        <label>时薪 A（标准）</label>
                        <input type="number" id="hourlyA" placeholder="例如 120" />
                    </div>
                    <div style="flex:1; min-width: 220px;">
                        <label>时薪 B（有效 · 推荐）</label>
                        <input type="number" id="hourlyB" placeholder="例如 90" />
                    </div>
                    <div style="flex:1; min-width: 220px;">
                        <label>时薪 C（私人时间）</label>
                        <input type="number" id="hourlyC" placeholder="例如 200" />
                    </div>
                </div>

                <div class="row" style="margin-top:8px;">
                    <div style="flex:1; min-width: 260px;">
                        <label>余额累计规则</label>
                        <select id="balanceRule">
                            <option value="learn_work">学习/工作计入，恢复/消费不计入（推荐）</option>
                            <option value="all_positive">除消费外都计入（学习/工作/恢复）</option>
                            <option value="manual">仅手动转入（记录不自动累积）</option>
                        </select>
                        <div class="hintline">决定“新增记录”时是否把本次等价价值加入余额。</div>
                    </div>

                    <div style="flex:1; min-width: 260px;">
                        <label>默认换算时薪</label>
                        <select id="defaultRate">
                            <option value="B">使用 B（有效时薪）</option>
                            <option value="A">使用 A（标准时薪）</option>
                            <option value="C">使用 C（私人时间）</option>
                        </select>
                        <div class="hintline">换算/回本/消费回本的默认时薪。</div>
                    </div>
                </div>

                <div class="btns">
                    <button class="primary" id="btnSaveSettings">保存设置</button>
                    <button id="btnLoadSettings">读取已保存设置</button>
                </div>

                <div class="aiBox">
                    <div class="row" style="justify-content:space-between;">
                        <div>
                            <b>AI 指导：估算 A/B/C（可选）</b>
                            <div class="hintline" style="margin-top:6px;">
                                输入你的基本收入与工作结构，AI 会给出更贴近现实的 A/B/C，并解释为什么这样估算。
                            </div>
                        </div>
                        <div class="chip">调用：/api/chat</div>
                    </div>

                    <div class="row" style="margin-top:10px;">
                        <div style="flex:1; min-width: 220px;">
                            <label>税后月收入（元）</label>
                            <input type="number" id="aiIncomeMonthly" placeholder="例如 20000" />
                        </div>
                        <div style="width: 220px; flex:0 0 220px;">
                            <label>每周工作天数</label>
                            <input type="number" id="aiWorkdays" placeholder="例如 5" />
                        </div>
                        <div style="width: 220px; flex:0 0 220px;">
                            <label>每天工作小时</label>
                            <input type="number" id="aiHoursPerDay" placeholder="例如 8" />
                        </div>
                    </div>

                    <div class="row" style="margin-top:6px;">
                        <div style="flex:1; min-width: 220px;">
                            <label>通勤/碎片时间（小时/天，可选）</label>
                            <input type="number" id="aiCommutePerDay" placeholder="例如 1.5" />
                        </div>
                        <div style="flex:1; min-width: 220px;">
                            <label>每周加班小时（可选）</label>
                            <input type="number" id="aiOvertimePerWeek" placeholder="例如 5" />
                        </div>
                        <div style="flex:1; min-width: 220px;">
                            <label>私人时间溢价倍数（C≈B×倍数，可选）</label>
                            <input type="number" id="aiPrivatePremium" placeholder="例如 2" />
                        </div>
                    </div>

                    <div class="btns">
                        <button class="primary" id="btnAiEstimate">让 AI 估算 A/B/C</button>
                        <button id="btnAiApply" disabled>应用到设置</button>
                        <button id="btnAiClear">清空</button>
                    </div>

                    <div class="aiOut" id="aiEstimateOutput" style="display:none;"></div>
                </div>
            </div>

            <div class="card">
                <h2>快捷操作</h2>
                <div class="desc">一些常用的小操作。</div>
                <div class="btns">
                    <button id="btnZeroBalance">余额归零</button>
                    <button id="btnRecalcKPIs">重算仪表盘</button>
                </div>
                <div class="hintline">
                    余额归零仅影响 tv.balance.v1，不会删除账本记录。
                </div>
            </div>
        </div>
    </section>

    <!-- 数据 -->
    <section class="section" id="sec-data">
        <div class="card">
            <h2>数据管理</h2>
            <div class="desc">导出/导入/重置，便于备份与迁移。</div>
            <div class="btns">
                <button id="btnExport">导出 JSON</button>
                <button id="btnImport">导入 JSON</button>
                <button class="danger" id="btnReset">重置全部数据</button>
            </div>
            <div class="hintline">
                导出会包含：设置（settings）/ 账本（logs）/ 余额（balance）。导入会覆盖本地数据。
            </div>
        </div>
    </section>

    <!-- 说明 -->
    <section class="section" id="sec-about">
        <div class="card">
            <h2>说明</h2>
            <div class="desc">
                <div class="hintline"><b>余额</b>：等价价值账户，用于决策，不是现金。</div>
                <div class="hintline"><b>消费</b>：不必填时长，用金额换算“回本时间”。</div>
                <div class="hintline"><b>AI</b>：当前仅用于“设置页估算 A/B/C”，后续再扩展到周复盘/建议摘要。</div>
                <div class="hintline">数据 keys：<span class="mono">tv.settings.v1 / tv.logs.v1 / tv.balance.v1</span></div>
            </div>
        </div>

        <div class="footer">
            先把体验和数据结构跑顺，再做 AI 的“复盘与策略”会更稳。
        </div>
    </section>

</div>

<div class="toast" id="toast"></div>

<script>
    // ===== Storage Keys (v1) =====
    const SETTINGS_KEY = "tv.settings.v1";
    const LOGS_KEY     = "tv.logs.v1";
    const BALANCE_KEY  = "tv.balance.v1";

    // Pages Functions endpoint
    const AI_ENDPOINT = "/api/chat";

    // ===== Defaults =====
    const DEFAULT_SETTINGS = {
        hourlyA: 120,
        hourlyB: 90,
        hourlyC: 200,
        balanceRule: "learn_work", // learn_work | all_positive | manual
        defaultRate: "B"
    };

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);

    function nowISO(){ return new Date().toISOString(); }
    function toLocalDateTime(iso){ return new Date(iso).toLocaleString(); }
    function clamp(n, min, max){
        if (Number.isNaN(n)) return null;
        return Math.max(min, Math.min(max, n));
    }
    function money(n){ return (Number(n||0)).toFixed(2); }
    function escapeHtml(str){
        return String(str)
            .replaceAll("&","&amp;")
            .replaceAll("<","&lt;")
            .replaceAll(">","&gt;")
            .replaceAll('"',"&quot;")
            .replaceAll("'","&#039;");
    }

    // ===== Toast =====
    let toastTimer = null;
    function toast(msg){
        const t = $("toast");
        t.textContent = msg;
        t.style.display = "block";
        clearTimeout(toastTimer);
        toastTimer = setTimeout(()=> t.style.display="none", 1800);
    }

    // ===== Settings =====
    function getSettings(){
        try{
            const raw = localStorage.getItem(SETTINGS_KEY);
            if(!raw) return {...DEFAULT_SETTINGS};
            return {...DEFAULT_SETTINGS, ...JSON.parse(raw)};
        }catch{
            return {...DEFAULT_SETTINGS};
        }
    }

    function applySettingsToUI(s){
        $("hourlyA").value = s.hourlyA ?? "";
        $("hourlyB").value = s.hourlyB ?? "";
        $("hourlyC").value = s.hourlyC ?? "";
        $("balanceRule").value = s.balanceRule ?? "learn_work";
        $("defaultRate").value = s.defaultRate ?? "B";

        // default selections on calc/log pages
        $("convertRate").value = s.defaultRate ?? "B";
        $("breakevenRate").value = s.defaultRate ?? "B";
        $("logRate").value = s.defaultRate ?? "B";
        $("spendRateQuick").value = s.defaultRate ?? "B";
    }

    function saveSettings(){
        const prev = getSettings();
        const hourlyA = parseFloat($("hourlyA").value);
        const hourlyB = parseFloat($("hourlyB").value);
        const hourlyC = parseFloat($("hourlyC").value);
        const balanceRule = $("balanceRule").value || prev.balanceRule;
        const defaultRate = $("defaultRate").value || prev.defaultRate;

        const next = {
            ...prev,
            hourlyA: Number.isFinite(hourlyA) ? hourlyA : prev.hourlyA,
            hourlyB: Number.isFinite(hourlyB) ? hourlyB : prev.hourlyB,
            hourlyC: Number.isFinite(hourlyC) ? hourlyC : prev.hourlyC,
            balanceRule,
            defaultRate
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(next));
        applySettingsToUI(next);
        recalcAll();
        toast("已保存设置");
    }

    function rateOf(code, s){
        if(code === "A") return Number(s.hourlyA || 0);
        if(code === "B") return Number(s.hourlyB || 0);
        if(code === "C") return Number(s.hourlyC || 0);
        return 0;
    }

    // ===== Balance =====
    function getBalance(){
        const v = parseFloat(localStorage.getItem(BALANCE_KEY) || "0");
        return Number.isFinite(v) ? v : 0;
    }
    function setBalance(v){
        const n = Number(v || 0);
        localStorage.setItem(BALANCE_KEY, String(n));
        $("balance").textContent = money(n);
    }

    // ===== Logs =====
    function getLogs(){
        try{ return JSON.parse(localStorage.getItem(LOGS_KEY) || "[]"); }
        catch{ return []; }
    }
    function saveLogs(logs){
        localStorage.setItem(LOGS_KEY, JSON.stringify(logs));
    }

    function shouldAutoAddToBalance(type, rule){
        if(rule === "learn_work") return type === "学习" || type === "工作";
        if(rule === "all_positive") return type !== "消费";
        return false; // manual
    }

    function computeValue(mins, hourly){
        const m = Number(mins || 0);
        const h = Number(hourly || 0);
        if(m <= 0 || h <= 0) return 0;
        return (m / 60) * h;
    }

    function computePaybackMinutes(cost, hourly){
        const c = Number(cost || 0);
        const h = Number(hourly || 0);
        if(c <= 0 || h <= 0) return 0;
        return (c / h) * 60;
    }

    function formatDuration(mins){
        const m = Math.round(mins || 0);
        if(m <= 0) return "0 分钟";
        if(m < 60) return `${m} 分钟`;
        const h = Math.floor(m / 60);
        const r = m % 60;
        if(r === 0) return `${h} 小时`;
        return `${h} 小时 ${r} 分钟`;
    }

    // ===== Navigation =====
    function activateSection(id){
        document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
        const target = document.getElementById(id);
        if(target) target.classList.add("active");

        document.querySelectorAll(".navbtn").forEach(b => b.classList.remove("active"));
        const btn = document.querySelector(`.navbtn[data-target="${id}"]`);
        if(btn) btn.classList.add("active");

        recalcAll();
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // ===== Convert =====
    function convert(){
        const s = getSettings();
        const mins = parseFloat($("minutes").value);
        const code = $("convertRate").value;
        const hourly = rateOf(code, s);

        if(!Number.isFinite(mins) || mins <= 0){
            $("convertResult").textContent = "请输入分钟数（>0）。";
            return;
        }
        if(hourly <= 0){
            $("convertResult").textContent = "请先在【设置】中设置对应时薪。";
            return;
        }
        const v = computeValue(mins, hourly);
        $("convertResult").textContent = `≈ ${money(v)} 元（按 ${code} 时薪 ${hourly}/h）`;
    }
    function clearConvert(){
        $("minutes").value = "";
        $("convertResult").textContent = "";
    }

    // ===== Breakeven =====
    function breakeven(){
        const s = getSettings();
        const cost = parseFloat($("cost").value);
        const saveMins = parseFloat($("saveTime").value);
        const code = $("breakevenRate").value;
        const hourly = rateOf(code, s);

        if(!Number.isFinite(cost) || cost <= 0){
            $("breakevenResult").textContent = "请输入成本（>0）。";
            return;
        }
        if(!Number.isFinite(saveMins) || saveMins <= 0){
            $("breakevenResult").textContent = "请输入每月节省分钟数（>0）。";
            return;
        }
        if(hourly <= 0){
            $("breakevenResult").textContent = "请先在【设置】中设置对应时薪。";
            return;
        }
        const monthlyValue = computeValue(saveMins, hourly);
        const months = monthlyValue > 0 ? (cost / monthlyValue) : Infinity;
        $("breakevenResult").textContent =
            `约 ${months.toFixed(1)} 个月回本（每月节省 ≈ ${money(monthlyValue)} 元等价，按 ${code} 时薪 ${hourly}/h）`;
    }
    function clearBreakeven(){
        $("cost").value = "";
        $("saveTime").value = "";
        $("breakevenResult").textContent = "";
    }

    // ===== Spend quick =====
    function spendQuick(){
        const s = getSettings();
        const cost = parseFloat($("spendCostQuick").value);
        const code = $("spendRateQuick").value;
        const hourly = rateOf(code, s);

        if(!Number.isFinite(cost) || cost <= 0){
            $("spendQuickResult").textContent = "请输入消费金额（>0）。";
            return;
        }
        if(hourly <= 0){
            $("spendQuickResult").textContent = "请先在【设置】中设置对应时薪。";
            return;
        }
        const mins = computePaybackMinutes(cost, hourly);
        $("spendQuickResult").textContent =
            `要赚回 ${money(cost)} 元，约需要 ${formatDuration(mins)}（按 ${code} 时薪 ${hourly}/h）`;
    }
    function spendQuickClear(){
        $("spendCostQuick").value = "";
        $("spendQuickResult").textContent = "";
    }

    // ===== Add Log (with spend) =====
    function toggleLogFields(){
        const type = $("type").value;
        const isSpend = type === "消费";
        $("durationWrap").style.display = isSpend ? "none" : "block";
        $("costWrap").style.display = isSpend ? "block" : "none";
        // quick add buttons
        const showQuick = !isSpend;
        $("btnQuickAdd10").style.display = showQuick ? "inline-block" : "none";
        $("btnQuickAdd30").style.display = showQuick ? "inline-block" : "none";
        $("btnQuickAdd60").style.display = showQuick ? "inline-block" : "none";
        updateLogPreview();
    }

    function updateLogPreview(){
        const s = getSettings();
        const type = $("type").value;
        const code = $("logRate").value;
        const hourly = rateOf(code, s);

        let preview = "";
        if(hourly <= 0){
            preview = "请先在【设置】中设置对应时薪。";
            $("logPreviewLine").textContent = preview;
            $("logValueRuleHint").textContent = "";
            return;
        }

        if(type === "消费"){
            const cost = parseFloat($("spendCost").value);
            if(!Number.isFinite(cost) || cost <= 0){
                preview = "请输入消费金额（元）。";
            }else{
                const mins = computePaybackMinutes(cost, hourly);
                preview = `消费 ${money(cost)} 元 → 需要 ${formatDuration(mins)} 才能回本（按 ${code} 时薪 ${hourly}/h）`;
            }
            $("logPreviewLine").textContent = preview;
            $("logValueRuleHint").textContent = "消费默认不计入余额（仅记录 + 回本换算）。";
            return;
        }

        const mins = parseFloat($("duration").value);
        const v = (Number.isFinite(mins) && mins > 0) ? computeValue(mins, hourly) : 0;
        preview = `本次时长 ${Number.isFinite(mins)?mins:0} 分钟 → 价值 ≈ ${money(v)} 元等价（按 ${code} 时薪 ${hourly}/h）`;
        $("logPreviewLine").textContent = preview;

        const rule = getSettings().balanceRule;
        const auto = shouldAutoAddToBalance(type, rule);
        let text = "";
        if(rule === "manual") text = "当前规则：仅手动转入（保存记录不会自动累积余额）。";
        else text = auto
            ? `当前规则：该类型会自动计入余额（保存后余额 +${money(v)}）。`
            : "当前规则：该类型默认不计入余额（只记录不累积）。";
        $("logValueRuleHint").textContent = text;
    }

    function addMinutes(delta){
        const current = parseFloat($("duration").value || "0");
        const next = Math.max(0, (Number.isFinite(current) ? current : 0) + delta);
        $("duration").value = next;
        updateLogPreview();
    }

    function addLog(){
        const s = getSettings();
        const type = $("type").value;
        const note = ($("note").value || "").trim();

        const recoverScore = clamp(parseFloat($("recoverScore").value), 0, 5);
        const assetScore   = clamp(parseFloat($("assetScore").value), 0, 5);
        const hasOutput    = $("hasOutput").value;

        const rateCode = $("logRate").value;
        const hourly = rateOf(rateCode, s);
        if(hourly <= 0){
            toast("请先在【设置】中设置对应时薪");
            return;
        }

        let duration = null;
        let value = 0;
        let spendCost = null;
        let paybackMins = null;

        if(type === "消费"){
            const cost = parseFloat($("spendCost").value);
            if(!Number.isFinite(cost) || cost <= 0){
                toast("消费记录需要填写金额（>0）");
                return;
            }
            spendCost = cost;
            paybackMins = computePaybackMinutes(cost, hourly);
            // 消费本身没有“时间价值收入”，不参与余额累计（先按你的现阶段需求）
            value = 0;
        }else{
            const mins = parseFloat($("duration").value);
            if(!Number.isFinite(mins) || mins <= 0){
                toast("请输入时长（分钟）> 0");
                return;
            }
            duration = mins;
            value = computeValue(mins, hourly);
        }

        const log = {
            id: Date.now(),
            at: nowISO(),
            type,
            duration,      // 非消费才有
            spendCost,     // 仅消费才有
            paybackMins,   // 仅消费才有（按记录时选择的时薪）
            note,
            recoverScore,
            assetScore,
            hasOutput,
            rateCode,
            hourly,
            value
        };

        const logs = getLogs();
        logs.unshift(log);
        saveLogs(logs);

        // Auto balance (only for non-spend & allowed)
        if(type !== "消费" && shouldAutoAddToBalance(type, s.balanceRule) && value > 0){
            setBalance(getBalance() + value);
        }

        // reset fields
        $("note").value = "";
        $("recoverScore").value = "";
        $("assetScore").value = "";
        $("hasOutput").value = "unknown";
        $("duration").value = "";
        $("spendCost").value = "";

        updateLogPreview();
        recalcAll();
        toast("已保存记录");
        activateSection("sec-dashboard");
    }

    // ===== Ledger Render =====
    function tagClass(type){
        if(type === "学习") return "learn";
        if(type === "工作") return "work";
        if(type === "恢复") return "rest";
        return "cost";
    }

    function renderRecent(){
        const logs = getLogs().slice(0, 8);
        const container = $("recentList");

        if(logs.length === 0){
            container.innerHTML = `<div class="item"><div class="left"><div class="note">暂无记录</div><div class="meta">去“新增记录”写下第一条吧。</div></div></div>`;
            return;
        }

        container.innerHTML = logs.map(l=>{
            const cls = tagClass(l.type);
            const mainLine = l.type === "消费"
                ? `<span class="chip">消费 ${money(l.spendCost||0)} 元</span>`
                : `<span class="chip">${l.duration} 分钟</span>`;

            const rightLine = l.type === "消费"
                ? `<div class="money">${formatDuration(l.paybackMins||0)}</div><div class="submoney">回本时间</div>`
                : `<div class="money">${l.value>0?`+ ${money(l.value)}`:`0.00`}</div><div class="submoney">等价价值</div>`;

            return `
        <div class="item">
          <div class="left">
            <div class="topline">
              <span class="tag ${cls}">${l.type}</span>
              ${mainLine}
              <span class="chip">按 ${l.rateCode}</span>
            </div>
            ${l.note ? `<div class="note">${escapeHtml(l.note)}</div>` : `<div class="meta">（无备注）</div>`}
            <div class="meta">${toLocalDateTime(l.at)}</div>
          </div>
          <div class="right">
            ${rightLine}
          </div>
        </div>
      `;
        }).join("");
    }

    function renderLogs(){
        const logs = getLogs();
        const limit = parseInt($("limit").value || "100", 10);
        const q = ($("searchText").value || "").trim().toLowerCase();
        const filter = $("filterType").value || "all";

        const filtered = logs.filter(l=>{
            const typeOk = (filter === "all") ? true : l.type === filter;
            const qOk = q ? ((l.note||"").toLowerCase().includes(q)) : true;
            return typeOk && qOk;
        }).slice(0, limit);

        const container = $("logs");
        if(filtered.length === 0){
            container.innerHTML = `<div class="item"><div class="left"><div class="note">暂无记录</div><div class="meta">调整筛选条件或新增记录。</div></div></div>`;
            return;
        }

        container.innerHTML = filtered.map(l=>{
            const cls = tagClass(l.type);
            const badges = [];
            if(Number.isFinite(l.recoverScore)) badges.push(`<span class="chip">恢复 ${l.recoverScore}/5</span>`);
            if(Number.isFinite(l.assetScore)) badges.push(`<span class="chip">资产 ${l.assetScore}/5</span>`);
            if(l.hasOutput === "yes") badges.push(`<span class="chip">有输出</span>`);
            if(l.hasOutput === "no") badges.push(`<span class="chip">无输出</span>`);

            const mid = l.type === "消费"
                ? `<span class="chip">消费 ${money(l.spendCost||0)} 元</span>`
                : `<span class="chip">${l.duration} 分钟</span>`;

            const rightBlock = l.type === "消费"
                ? `<div class="money">${formatDuration(l.paybackMins||0)}</div>
           <div class="submoney">回本时间（按 ${l.rateCode} 时薪 ${l.hourly}/h）</div>`
                : `<div class="money">${l.value>0?`+ ${money(l.value)} 元`:`0.00`}</div>
           <div class="submoney">等价价值（非收入）</div>`;

            return `
        <div class="item">
          <div class="left">
            <div class="topline">
              <span class="tag ${cls}">${l.type}</span>
              ${mid}
              <span class="chip">按 ${l.rateCode}（${l.hourly}/h）</span>
              ${badges.join("")}
            </div>
            ${l.note ? `<div class="note">${escapeHtml(l.note)}</div>` : `<div class="meta">（无备注）</div>`}
            <div class="meta">${toLocalDateTime(l.at)}</div>
          </div>
          <div class="right">
            ${rightBlock}
          </div>
        </div>
      `;
        }).join("");
    }

    // ===== KPIs (14 days) =====
    function calcKPIs(){
        const logs = getLogs();
        const s = getSettings();
        const days = 14;
        const since = Date.now() - days * 24 * 60 * 60 * 1000;

        const recent = logs.filter(l=>{
            const t = new Date(l.at).getTime();
            return Number.isFinite(t) && t >= since;
        });

        const count = recent.length;

        // 只统计“有时长”的记录（消费 duration=null）
        const recentWithDuration = recent.filter(l => Number.isFinite(Number(l.duration)) && Number(l.duration) > 0);

        const totalMins = recentWithDuration.reduce((a,l)=> a + Number(l.duration||0), 0);
        const focusMins = recentWithDuration
            .filter(l => l.type === "学习" || l.type === "工作")
            .reduce((a,l)=> a + Number(l.duration||0), 0);

        const focusPct = totalMins > 0 ? (focusMins / totalMins) * 100 : 0;

        const hourly = rateOf(s.defaultRate || "B", s);
        const value = computeValue(totalMins, hourly);

        $("kpiCount").textContent = String(count);
        $("kpiMins").textContent = `${Math.round(totalMins)} 分钟`;
        $("kpiFocus").textContent = `${focusPct.toFixed(0)}%`;
        $("kpiValue").textContent = money(value);
    }

    function recalcAll(){
        setBalance(getBalance());
        calcKPIs();
        renderRecent();
        renderLogs();
        updateLogPreview();
    }

    // ===== Data Tools =====
    function exportJSON(){
        const data = {
            version: 1,
            exportedAt: nowISO(),
            settings: getSettings(),
            balance: getBalance(),
            logs: getLogs()
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `time-value-toolbox-export-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        toast("已导出 JSON");
    }

    function importJSON(){
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "application/json";
        input.onchange = async () => {
            const file = input.files && input.files[0];
            if(!file) return;
            const text = await file.text();
            try{
                const data = JSON.parse(text);
                if(!data || typeof data !== "object") throw new Error("bad");
                if(!data.settings || !Array.isArray(data.logs)) throw new Error("missing");
                localStorage.setItem(SETTINGS_KEY, JSON.stringify({...DEFAULT_SETTINGS, ...data.settings}));
                localStorage.setItem(LOGS_KEY, JSON.stringify(data.logs));
                localStorage.setItem(BALANCE_KEY, String(Number(data.balance||0)));
                applySettingsToUI(getSettings());
                recalcAll();
                toast("已导入并覆盖本地数据");
            }catch{
                toast("导入失败：JSON 格式不正确");
            }
        };
        input.click();
    }

    function resetAll(){
        const ok = confirm("确定要重置吗？将清空本地设置/账本/余额，无法恢复。");
        if(!ok) return;
        localStorage.removeItem(SETTINGS_KEY);
        localStorage.removeItem(LOGS_KEY);
        localStorage.removeItem(BALANCE_KEY);
        applySettingsToUI(getSettings());
        recalcAll();
        toast("已重置");
    }

    function clearLogs(){
        const ok = confirm("确定清空账本吗？仅清空 logs，余额与设置不变。");
        if(!ok) return;
        localStorage.setItem(LOGS_KEY, "[]");
        recalcAll();
        toast("已清空账本");
    }

    // ===== AI Estimate (Settings page) =====
    let lastAiSuggested = null;

    function parseFirstJsonObject(text){
        // 尝试从回复里提取 JSON（支持模型输出夹杂说明）
        const start = text.indexOf("{");
        const end = text.lastIndexOf("}");
        if(start === -1 || end === -1 || end <= start) return null;
        const maybe = text.slice(start, end+1);
        try{ return JSON.parse(maybe); }catch{ return null; }
    }

    async function callAI(messages){
        const res = await fetch(AI_ENDPOINT, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ messages })
        });
        if(!res.ok){
            const t = await res.text().catch(()=> "");
            throw new Error(`HTTP ${res.status} ${t}`.slice(0,300));
        }
        const data = await res.json();
        const content = data?.choices?.[0]?.message?.content || "";
        return content;
    }

    async function aiEstimateABC(){
        const monthly = parseFloat($("aiIncomeMonthly").value);
        const workdays = parseFloat($("aiWorkdays").value);
        const hoursDay = parseFloat($("aiHoursPerDay").value);
        const commute = parseFloat($("aiCommutePerDay").value || "0");
        const overtime = parseFloat($("aiOvertimePerWeek").value || "0");
        const premium = parseFloat($("aiPrivatePremium").value || "2");

        if(!Number.isFinite(monthly) || monthly <= 0){
            toast("请填写税后月收入（>0）");
            return;
        }
        if(!Number.isFinite(workdays) || workdays <= 0 || workdays > 7){
            toast("请填写合理的每周工作天数（1-7）");
            return;
        }
        if(!Number.isFinite(hoursDay) || hoursDay <= 0 || hoursDay > 24){
            toast("请填写合理的每天工作小时（>0）");
            return;
        }

        $("btnAiEstimate").disabled = true;
        $("btnAiApply").disabled = true;
        $("aiEstimateOutput").style.display = "block";
        $("aiEstimateOutput").textContent = "AI 正在估算中…";

        const userPayload = {
            monthly_take_home_income: monthly,
            workdays_per_week: workdays,
            work_hours_per_day: hoursDay,
            commute_hours_per_day: Number.isFinite(commute) ? commute : 0,
            overtime_hours_per_week: Number.isFinite(overtime) ? overtime : 0,
            private_time_premium_multiplier: Number.isFinite(premium) ? premium : 2
        };

        const system = [
            "你是一个非常务实的个人财务与时间价值顾问。",
            "目标：根据用户提供的收入和工作结构，估算三个时薪：",
            "A=标准时薪（以合同/岗位为基准的小时产出），",
            "B=有效时薪（考虑通勤/加班/碎片化等导致的有效可支配下降，通常<=A，推荐日常使用），",
            "C=私人时间定价（用户私人时间底价，通常>=B，可用倍数表达）。",
            "请输出 JSON（不要使用代码块），字段必须包含：hourlyA, hourlyB, hourlyC, reasoning, assumptions。",
            "hourlyA/hourlyB/hourlyC 为数字（元/小时），保留 1 位小数以内即可。"
        ].join("\n");

        const user = [
            "用户输入如下（JSON）：",
            JSON.stringify(userPayload),
            "",
            "请你：",
            "1) 给出 hourlyA/hourlyB/hourlyC",
            "2) 简要说明推导逻辑（reasoning）",
            "3) 写明你做了哪些默认假设（assumptions），例如：每月按 4.33 周/或 4 周等"
        ].join("\n");

        try{
            const content = await callAI([
                {role:"system", content: system},
                {role:"user", content: user}
            ]);

            const obj = parseFirstJsonObject(content);
            if(obj && typeof obj === "object"){
                lastAiSuggested = obj;
                $("aiEstimateOutput").textContent =
                    `AI 建议（可应用）：\n` +
                    `A = ${obj.hourlyA} 元/小时\n` +
                    `B = ${obj.hourlyB} 元/小时\n` +
                    `C = ${obj.hourlyC} 元/小时\n\n` +
                    `reasoning: ${obj.reasoning || ""}\n\n` +
                    `assumptions: ${obj.assumptions || ""}`;
                $("btnAiApply").disabled = false;
            }else{
                lastAiSuggested = null;
                $("aiEstimateOutput").textContent =
                    "AI 返回了结果，但未解析到标准 JSON。\n\n原文如下：\n" + content;
            }
        }catch(e){
            lastAiSuggested = null;
            $("aiEstimateOutput").textContent = "AI 调用失败：\n" + (e?.message || String(e));
        }finally{
            $("btnAiEstimate").disabled = false;
        }
    }

    function aiApplyABC(){
        if(!lastAiSuggested) return;
        const a = parseFloat(lastAiSuggested.hourlyA);
        const b = parseFloat(lastAiSuggested.hourlyB);
        const c = parseFloat(lastAiSuggested.hourlyC);
        if(!Number.isFinite(a) || !Number.isFinite(b) || !Number.isFinite(c)){
            toast("AI 建议值不合法，无法应用");
            return;
        }
        $("hourlyA").value = a;
        $("hourlyB").value = b;
        $("hourlyC").value = c;
        saveSettings();
        toast("已应用 AI 建议到 A/B/C");
    }

    function aiClear(){
        lastAiSuggested = null;
        $("aiIncomeMonthly").value = "";
        $("aiWorkdays").value = "";
        $("aiHoursPerDay").value = "";
        $("aiCommutePerDay").value = "";
        $("aiOvertimePerWeek").value = "";
        $("aiPrivatePremium").value = "";
        $("aiEstimateOutput").style.display = "none";
        $("aiEstimateOutput").textContent = "";
        $("btnAiApply").disabled = true;
    }

    // ===== Init =====
    function init(){
        const s = getSettings();
        applySettingsToUI(s);

        // Nav
        $("nav").addEventListener("click", (e)=>{
            const btn = e.target.closest(".navbtn");
            if(!btn) return;
            activateSection(btn.dataset.target);
        });

        // Settings
        $("btnSaveSettings").addEventListener("click", saveSettings);
        $("btnLoadSettings").addEventListener("click", ()=>{
            applySettingsToUI(getSettings());
            recalcAll();
            toast("已读取设置");
        });

        // Calc
        $("btnConvert").addEventListener("click", convert);
        $("btnConvertClear").addEventListener("click", clearConvert);
        $("btnBreakeven").addEventListener("click", breakeven);
        $("btnBreakevenClear").addEventListener("click", clearBreakeven);
        $("btnSpendQuick").addEventListener("click", spendQuick);
        $("btnSpendQuickClear").addEventListener("click", spendQuickClear);

        // Log
        $("type").addEventListener("change", toggleLogFields);
        $("duration").addEventListener("input", updateLogPreview);
        $("spendCost").addEventListener("input", updateLogPreview);
        $("logRate").addEventListener("change", updateLogPreview);
        $("btnAddLog").addEventListener("click", addLog);
        $("btnQuickAdd10").addEventListener("click", ()=> addMinutes(10));
        $("btnQuickAdd30").addEventListener("click", ()=> addMinutes(30));
        $("btnQuickAdd60").addEventListener("click", ()=> addMinutes(60));

        // Ledger
        $("filterType").addEventListener("change", renderLogs);
        $("searchText").addEventListener("input", renderLogs);
        $("limit").addEventListener("change", renderLogs);
        $("btnRefresh").addEventListener("click", ()=>{ recalcAll(); toast("已刷新"); });
        $("btnClearLogs").addEventListener("click", clearLogs);

        // Data
        $("btnExport").addEventListener("click", exportJSON);
        $("btnImport").addEventListener("click", importJSON);
        $("btnReset").addEventListener("click", resetAll);

        // Quick ops
        $("btnZeroBalance").addEventListener("click", ()=>{
            const ok = confirm("确定把余额归零吗？账本记录不会删除。");
            if(!ok) return;
            setBalance(0);
            toast("余额已归零");
        });
        $("btnRecalcKPIs").addEventListener("click", ()=>{
            recalcAll();
            toast("已重算");
        });

        // AI settings
        $("btnAiEstimate").addEventListener("click", aiEstimateABC);
        $("btnAiApply").addEventListener("click", aiApplyABC);
        $("btnAiClear").addEventListener("click", aiClear);

        // First render
        setBalance(getBalance());
        toggleLogFields();
        recalcAll();
    }

    init();
</script>
</body>
</html>
